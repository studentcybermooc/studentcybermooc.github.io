<!DOCTYPE html>
<html lang="en" dir="ltr">

  <head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<meta property="og:title" content="Flask - Part 4">
    
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2018-09-24">
    
	<meta property="og:description" content="Adding users and login/signup routes">
    <meta property="og:url" content="https://studentcybermooc.github.io/courses/dev/python/flask_part_4/">
	<meta property="og:site_name" content="Cyber MOOC">
	<meta property="og:description" content="ENSIBS Student Cyber MOOC">
	
    <meta property="og:tags" content="flask">
	
    <meta property="og:tags" content="sqlalchemy">
	

	
	<meta property="twitter:card" content="Adding users and login/signup routes">
	<meta property="twitter:card" content="Flask - Part 4">
	<meta property="twitter:description" content="Adding users and login/signup routes">
	<meta property="twitter:title" content="Flask - Part 4">

	<meta name="generator" content="Hugo 0.89.4" />

	<link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">
	<link rel="icon" href="/img/favicon.ico" type="image/x-icon">

	

    <title>Cyber MOOC</title>
    <link rel="stylesheet" href="/assets/css/main.css">
</head>

  <body>
    <div id="top"></div>
<nav>
	<p>
		<a href="/">Home</a>
				
		· <a href="/authors/">Authors</a>
				
		· <a href="/courses/">Courses</a>
				
		· <a href="/collaborate/">Collaborate</a>
				
		· <a href="/about/">About</a>
				
		· <a href="/index.xml">RSS</a>
	</p>
</nav>

<img id="up" src="/img/to_the_top.png" onclick="document.getElementById('top').scrollIntoView({behavior:'smooth'});">

    <main class="post">
        <article>
          <header>
              <h1>Flask - Part 4</h1>
              <p class="post_date">24 Sep 2018 · 6 min read</p>
              
              <p class="post_tags">
                
                  <a href="tags/flask">flask</a>
                
                  · <a href="tags/sqlalchemy">sqlalchemy</a>
                
              </p>
              
              
              <p class="post_authors">by
                
                
                  <a href="/authors/gmolveau/" target="_new" rel="nofollow">gmolveau</a> ·
                
              </p>
              
              <section class="post_toc">
                <input id="toc-toggle" type="checkbox">
                <label for="toc-toggle" id="toggle">
                  <p class="toc-title">Jump to section... <span class="dropdown-icon">⚓</span></p>
                </label>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#setting-up">Setting up</a></li>
      </ul>
    </li>
    <li><a href="#1---bcrypt">1 - Bcrypt</a>
      <ul>
        <li><a href="#11---installing-bcrypt">1.1 - Installing bcrypt</a></li>
        <li><a href="#12---adding-bcrypt-to-our-app">1.2 - Adding bcrypt to our app</a></li>
      </ul>
    </li>
    <li><a href="#2---updating-our-model">2 - Updating our model</a></li>
    <li><a href="#4---creating-our-routes">4 - Creating our routes</a>
      <ul>
        <li><a href="#41---signup-route">4.1 - Signup route</a></li>
        <li><a href="#42---login">4.2 - Login</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
              </section>
          </header>
          <hr>
          <h2 id="introduction">Introduction</h2>
<p>This <code>version_4</code> will show you how to create signup and login routes.</p>
<h3 id="setting-up">Setting up</h3>
<p>To begin we will start from our previous version_3 app. If you don&rsquo;t have it anymore, no worries, simply copy the reference code :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning</span>
cp -R flask_cybermooc/version_3 my_app_v4
cd my_app_v4
</code></pre></div><p>and initialize our venv :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning/my_app_v4</span>
virtualenv venv -p python3
source venv/bin/activate
<span style="color:#75715e"># (venv)</span>
pip install -r requirements.txt <span style="color:#75715e"># install from the requirements.txt file</span>
</code></pre></div><p>All set up ? let&rsquo;s begin.</p>
<h2 id="1---bcrypt">1 - Bcrypt</h2>
<p>Because we will store passwords, we need to store them properly. (no md5 is not a proper way to store password). We will use the <a href="https://en.wikipedia.org/wiki/Bcrypt">bcrypt algorithm</a>.</p>
<h3 id="11---installing-bcrypt">1.1 - Installing bcrypt</h3>
<p>In our venv, let&rsquo;s install <code>flask-bcrypt</code> which contains bcrypt + a wrapper for flask.</p>
<p>And we don&rsquo;t forget to update our <code>requirements.txt</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning/my_app_v4 (venv)</span>
pip install flask-bcrypt
pip freeze &gt; requirements.txt
</code></pre></div><h3 id="12---adding-bcrypt-to-our-app">1.2 - Adding bcrypt to our app</h3>
<p>Now that bcrypt is installed, we need to tell our app to use bcrypt when it starts.</p>
<p>It’s a good idea to keep the Marshmallow object instance in a separate file, to avoid <a href="https://en.wikipedia.org/wiki/Circular_dependency">circular imports</a>.</p>
<p>To do so, let&rsquo;s create the marshmallow file :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning/my_app_v4 (venv)</span>
touch app/bcrypt.py
</code></pre></div><p>and add this code :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># bcrypt.py</span>

<span style="color:#f92672">from</span> flask_bcrypt <span style="color:#f92672">import</span> Bcrypt

bc <span style="color:#f92672">=</span> Bcrypt()
</code></pre></div><p>In the application_factory <code>__init__.py</code>, let&rsquo;s update our code :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># app/__init__.py</span>

<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_app</span>():
    app <span style="color:#f92672">=</span> Flask(__name__)
    
    <span style="color:#f92672">from</span> os <span style="color:#f92672">import</span> environ <span style="color:#66d9ef">as</span> env
    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_DATABASE_URI&#39;</span>] <span style="color:#f92672">=</span> env<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;DATABASE_URL&#39;</span>)
    app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>

    <span style="color:#f92672">from</span> .database <span style="color:#f92672">import</span> db
    db<span style="color:#f92672">.</span>init_app(app)

    <span style="color:#f92672">from</span> .bcrypt <span style="color:#f92672">import</span> bc
    bc<span style="color:#f92672">.</span>init_app(app)

    <span style="color:#f92672">from</span> .cli <span style="color:#f92672">import</span> cli_init_app
    cli_init_app(app)

    <span style="color:#f92672">from</span> .api_v1 <span style="color:#f92672">import</span> api_v1_blueprint, root_blueprint
    app<span style="color:#f92672">.</span>register_blueprint(root_blueprint)
    app<span style="color:#f92672">.</span>register_blueprint(api_v1_blueprint)

    <span style="color:#66d9ef">return</span> app
</code></pre></div><p><code>Bcrypt</code> is now imported and initialized.</p>
<h2 id="2---updating-our-model">2 - Updating our model</h2>
<p>In <code>app/models/user.py</code> we can now add some methods to use bcrypt.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># models/user.py</span>
<span style="color:#75715e"># http://docs.sqlalchemy.org/en/latest/orm/extensions/declarative/basic_use.html</span>

<span style="color:#f92672">from</span> .base <span style="color:#f92672">import</span> Base
<span style="color:#f92672">from</span> ..bcrypt <span style="color:#f92672">import</span> bc
<span style="color:#f92672">from</span> ..database <span style="color:#f92672">import</span> db


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(Base):

    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;users&#39;</span>

    username <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
    email <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, unique<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
    encrypted_password <span style="color:#f92672">=</span> db<span style="color:#f92672">.</span>Column(db<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_password</span>(self, password):
        self<span style="color:#f92672">.</span>encrypted_password <span style="color:#f92672">=</span> bc<span style="color:#f92672">.</span>generate_password_hash(password)

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_password</span>(self, password):
        <span style="color:#66d9ef">return</span> bc<span style="color:#f92672">.</span>check_password_hash(self<span style="color:#f92672">.</span>encrypted_password, password)
</code></pre></div><h2 id="4---creating-our-routes">4 - Creating our routes</h2>
<p>In <code>app/api_v1</code>, let&rsquo;s create a file <code>user.py</code> for the routes of the user :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning/my_app_v4 (venv)</span>
touch app/api_v1/user.py
</code></pre></div><p>We import those routes in our module <code>app/api_v1/__init__.py</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># app/api_v1/__init__.py</span>

<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Blueprint

root_blueprint <span style="color:#f92672">=</span> Blueprint(<span style="color:#e6db74">&#39;api_v1&#39;</span>, __name__)
api_v1_blueprint <span style="color:#f92672">=</span> Blueprint(<span style="color:#e6db74">&#39;api_v1&#39;</span>, __name__, url_prefix<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/api/v1&#39;</span>)

<span style="color:#75715e"># Import any endpoints here to make them available</span>
<span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> hello
<span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> user
</code></pre></div><h3 id="41---signup-route">4.1 - Signup route</h3>
<p>To signup, the route will receive a username, an email and a password.</p>
<p>In <code>app/api_v1/user.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># app/api_v1/user.py</span>

<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> (
    jsonify, request
)
<span style="color:#f92672">from</span> . <span style="color:#f92672">import</span> api_v1_blueprint
<span style="color:#f92672">from</span> ..database <span style="color:#f92672">import</span> db
<span style="color:#f92672">from</span> ..models.user <span style="color:#f92672">import</span> User


<span style="color:#a6e22e">@api_v1_blueprint</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/signup&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">signup</span>():
    datas <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>get_json()
    username <span style="color:#f92672">=</span> datas<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
    <span style="color:#66d9ef">if</span> username <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;&#39;</span>:
        <span style="color:#66d9ef">return</span> jsonify(error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;username is empty&#34;</span>),<span style="color:#ae81ff">422</span>
    email <span style="color:#f92672">=</span> datas<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;email&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
    <span style="color:#66d9ef">if</span> email <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;&#39;</span>:
        <span style="color:#66d9ef">return</span> jsonify(error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;email is empty&#34;</span>),<span style="color:#ae81ff">422</span>
    <span style="color:#75715e"># we could verify that this email is valid</span>
    password <span style="color:#f92672">=</span> datas<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
    <span style="color:#66d9ef">if</span> password <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;&#39;</span>:
        <span style="color:#66d9ef">return</span> jsonify(error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password is empty&#34;</span>),<span style="color:#ae81ff">422</span>
    <span style="color:#66d9ef">if</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>username <span style="color:#f92672">==</span> username)<span style="color:#f92672">.</span>first() <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
        <span style="color:#66d9ef">return</span> jsonify(err<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;username already taken&#34;</span>), <span style="color:#ae81ff">409</span>
    <span style="color:#66d9ef">if</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>email <span style="color:#f92672">==</span> email)<span style="color:#f92672">.</span>first() <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
        <span style="color:#66d9ef">return</span> jsonify(err<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;email already signed-up&#34;</span>), <span style="color:#ae81ff">409</span>
    new_user <span style="color:#f92672">=</span> User()
    new_user<span style="color:#f92672">.</span>username <span style="color:#f92672">=</span> username
    new_user<span style="color:#f92672">.</span>email <span style="color:#f92672">=</span> email
    new_user<span style="color:#f92672">.</span>set_password(password)
    db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>add(new_user)
    db<span style="color:#f92672">.</span>session<span style="color:#f92672">.</span>commit()
    <span style="color:#66d9ef">return</span> jsonify(msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;welcome :-)&#34;</span>), <span style="color:#ae81ff">200</span>
</code></pre></div><p>Explaining :</p>
<ul>
<li>line 15 : reading the json we received</li>
<li>lines 17 to 26 : checking that the differents JSON fields are correct (not empty etc&hellip;)</li>
<li>lines 27-28 : calling the controller to create the user</li>
<li>line 29 : if the controller does not raise any exception, we can proceed</li>
<li>lines 30-31 : return the error</li>
</ul>
<h4 id="411---adding-the-unit-test">4.1.1 - Adding the unit test</h4>
<p>In our folder <code>tests</code>, let&rsquo;s add a file <code>test_2_signup_route.py</code> : (we add a number to order the tests)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># tests/test_2_signup_route.py</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_signup_empty_password</span>(client):
    <span style="color:#75715e"># testing errors</span>
    empty_password <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/signup&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;test_user@mail.com&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> empty_password<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">422</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_signup_empty_username</span>(client):
    empty_username <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/signup&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;test_user@mail.com&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> empty_username<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">422</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_signup_empty_email</span>(client):
    empty_email <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/signup&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> empty_email<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">422</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_signup_correct</span>(client):
    correct <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/signup&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;test_user@mail.com&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> correct<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_signup_username_taken</span>(client):
    username_taken <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/signup&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;test_user@mail.com&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> username_taken<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">409</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_signup_email_taken</span>(client):
    email_taken <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/signup&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>, <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#e6db74">&#39;test_user@mail.com&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> email_taken<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">409</span>
</code></pre></div><p><img src="/img/courses/dev/python/flask_part_4/v4_unittest_signup.png" alt="v4 unittest"></p>
<h4 id="412---testing-this-signup-route">4.1.2 - Testing this signup route</h4>
<p>Let&rsquo;s run our app, initiate the database and test this route :-)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning/my_app_v4 (venv)</span>
flask reset-db
flask run
</code></pre></div><ul>
<li>
<p>Postman :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_postman_signup.png" alt="v4 postman signup example"></p>
<p><strong>Success</strong>, it&rsquo;s working great :)</p>
<p>And if we try to signup again with the same username :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_postman_signup_error.png" alt="v4 postman signup error"></p>
<p>We got our error back. Great !</p>
</li>
<li>
<p>HTTPie :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_httpie_signup.png" alt="v4 httpie signup example"></p>
<p><strong>Success</strong>, it&rsquo;s working great :)</p>
<p>And if we try to signup again with the same username :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_httpie_signup_error.png" alt="v4 httpie signup error"></p>
<p>We got our error back. Great !</p>
</li>
</ul>
<p>Perfect, our app is working great :)</p>
<p>A quick check inside the database to be sure the data is stored :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_sqlite_check.png" alt="v4 sqlitebrowser check"></p>
<p>The password is encrypted and our user is there, no problem !</p>
<h3 id="42---login">4.2 - Login</h3>
<p>In <code>app/api_v1/user.py</code>, at the end of the file, let&rsquo;s add our login route :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># app/api_v1/user.py</span>

[<span style="color:#f92672">...</span>]

<span style="color:#a6e22e">@api_v1_blueprint</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
    datas <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>get_json()
    username <span style="color:#f92672">=</span> datas<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
    <span style="color:#66d9ef">if</span> username <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;&#39;</span>:
        <span style="color:#66d9ef">return</span> jsonify(error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;username is empty&#34;</span>),<span style="color:#ae81ff">422</span>
    password <span style="color:#f92672">=</span> datas<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
    <span style="color:#66d9ef">if</span> password <span style="color:#f92672">is</span> <span style="color:#e6db74">&#39;&#39;</span>:
        <span style="color:#66d9ef">return</span> jsonify(error<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password is empty&#34;</span>),<span style="color:#ae81ff">422</span>
    user <span style="color:#f92672">=</span> User<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>filter(User<span style="color:#f92672">.</span>username <span style="color:#f92672">==</span> username)<span style="color:#f92672">.</span>first()
    <span style="color:#66d9ef">if</span> user <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
        <span style="color:#66d9ef">if</span> user<span style="color:#f92672">.</span>verify_password(password):
            <span style="color:#66d9ef">return</span> jsonify(msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;welcome&#34;</span>), <span style="color:#ae81ff">200</span>
        <span style="color:#66d9ef">return</span> jsonify(err<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;password incorrect&#34;</span>), <span style="color:#ae81ff">401</span>
    <span style="color:#66d9ef">return</span> jsonify(err<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;username incorrect&#34;</span>), <span style="color:#ae81ff">404</span>
</code></pre></div><h4 id="421---adding-the-unit-test">4.2.1 - Adding the unit test</h4>
<p>In our folder <code>tests</code>, let&rsquo;s add a file <code>test_3_login_route.py</code> : (we add a number to order the tests)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># tests/test_3_login_route.py</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_empty_password</span>(client):
    <span style="color:#75715e"># testing errors</span>
    empty_password <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/login&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> empty_password<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">422</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_empty_username</span>(client):
    empty_username <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/login&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> empty_username<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">422</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_correct</span>(client):
    correct <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/login&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> correct<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_wrong_username</span>(client):
    wrong_username <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/login&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testusernot&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> wrong_username<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">404</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_wrong_password</span>(client):
    wrong_password <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;/api/v1/login&#34;</span>, json<span style="color:#f92672">=</span>{
        <span style="color:#e6db74">&#39;username&#39;</span>: <span style="color:#e6db74">&#39;testuser&#39;</span>, <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;test_user_wrong&#39;</span>
    })
    <span style="color:#66d9ef">assert</span> wrong_password<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">401</span>
</code></pre></div><p><img src="/img/courses/dev/python/flask_part_4/v4_unittest_login.png" alt="v4 unittest"></p>
<h4 id="421---testing-this-login-route">4.2.1 - Testing this login route</h4>
<p>Let&rsquo;s run our app :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># assuming you&#39;re in flask_learning/my_app_v4 (venv )</span>
flask run 
</code></pre></div><ul>
<li><code>Postman</code> :</li>
</ul>
<p>Success :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_postman_login.png" alt="v4 postman login example"></p>
<p>Fail :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_postman_login_error.png" alt="v4 postman login error"></p>
<ul>
<li><code>HTTPie</code> :</li>
</ul>
<p>Success :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_httpie_login.png" alt="v4 httpie login example"></p>
<p>Fail :</p>
<p><img src="/img/courses/dev/python/flask_part_4/v4_httpie_login_error.png" alt="v4 httpie login error"></p>
<h2 id="conclusion">Conclusion</h2>
<p>If you&rsquo;re stuck or don&rsquo;t understand something, feel free to drop <a href="/authors/gmolveau/">me an email / dm on twitter</a> / a comment below. You can also take a look at <code>flask_learning/flask_cybermooc/version_4</code> to see the reference code. And use <code>run.sh</code> to launch it.</p>
<p>Otherwise, <strong>congratulations</strong> ! You just learned how to create two main routes &ldquo;login&rdquo; and &ldquo;signup&rdquo;. (well your users aren&rsquo;t technically logged-in but still)</p>
<p>If you understood everything, in <a href="/courses/dev/python/flask_part_5/">part 5</a> you will see how to use <a href="https://jwt.io/introduction/">JSON Web Tokens</a>, a cool way to authentify your users.</p>

          <hr>
        </article>
    </main>

    <div id="gh-comments">
    <header class="text-center">
        <h4>COMMENTS</h4>
    </header>
    <div id="gh-comments-list"></div>
</div>

<script type="text/javascript">

function parse_links(headers_link){
    var links = { };
    for (var i in headers_link){
        var entry = headers_link[i];
        var link = { };
        link.name = entry.match(/rel=\"([^\"]*)/)[1];
        link.url = entry.match(/<([^>]*)/)[1];
        link.page = entry.match(/page=(\d+).*$/)[1];
        links[link.name] = link;
    }
    return links;
}

function create_comment_btn(issue_id) {
    let page_comments = document.querySelectorAll('#gh-comments > header')[0];
    const url_issues = "https://github.com//issues/"+issue_id;
    var new_comment_btn = document.createElement('a');
    new_comment_btn.setAttribute('href', url_issues + "#new_comment_field");
    new_comment_btn.setAttribute('rel', 'nofollow');
    new_comment_btn.setAttribute('target', '_new');
    new_comment_btn.setAttribute('class', 'btngithub')
    new_comment_btn.innerText = 'Post a comment on Github';
    page_comments.appendChild(new_comment_btn);
}

function comments_closed() {
    let comments_list = document.getElementById("gh-comments-list");
    comments_list.innerHTML += "Comments are not open for this post yet.";
}

function create_comment_div(comment) {
    const date_creation = new Date(comment.created_at);
    const date_creation_string = date_creation.getUTCFullYear() +"/"+ (date_creation.getUTCMonth()+1) +"/"+ date_creation.getUTCDate() + " at " + date_creation.getUTCHours() + ":" + date_creation.getUTCMinutes();
    let div_gh_comment = document.createElement('div');
    div_gh_comment.setAttribute("class", "gh-comment");
    let sub_div = document.createElement('div');
    let img_avatar = document.createElement("img");
    img_avatar.setAttribute("src", comment.user.avatar_url);
    let link_profile = document.createElement('a');
    link_profile.setAttribute("href", comment.user.html_url);
    link_profile.innerText = comment.user.login;
    let date_comment = document.createElement("em");
    date_comment.innerText = date_creation_string;
    sub_div.appendChild(img_avatar);
    sub_div.appendChild(link_profile);
    sub_div.innerHTML += " posted on ";
    sub_div.appendChild(date_comment);
    div_gh_comment.appendChild(sub_div);
    div_gh_comment.innerHTML += comment['body'];
    let comments_list = document.getElementById("gh-comments-list");
    comments_list.appendChild(div_gh_comment);
}

function get_comments(issues_url, issue_id) {
    let request = new XMLHttpRequest();
    request.open('GET', issues_url);
    request.onload = function() {
        var data = JSON.parse(request.responseText);
        if (data.message === 'Not Found') {
            comments_closed();
            return;
        }
        create_comment_btn(issue_id);
        for (var index_comment in data) {
            comment = data[index_comment];
           create_comment_div(comment);
        }
        let more_comments = request.getResponseHeader("Link");
        if (more_comments !== null) {
            
            let links = parse_links(more_comments);
        }
    };
    request.onerror = function() {
        comments_closed();
    };
    request.send();
}

function load_comments(){
    document.addEventListener('DOMContentLoaded', function(){
        const issue_id = "22"; 
        const issues_url = "https://api.github.com/repos/studentcybermooc\/studentcybermooc.github.io/issues/"+issue_id+"/comments";
        if (issue_id !== undefined && issue_id > 0) {
            get_comments(issues_url, issue_id);
        } else {
            comments_closed();
        }
    });
}

load_comments();
</script>

  <script>
    (function() {
      var toc = document.getElementById('TableOfContents');
      if (!toc) return;
      do {
        var li, ul = toc.querySelector('ul');
        if (ul.childElementCount !== 1) break;
        li = ul.firstElementChild;
        if (li.tagName !== 'LI') break;
        
        ul.outerHTML = li.innerHTML;
      } while (toc.childElementCount >= 1);
    })();
  </script>
    
  <link rel="stylesheet" href="/assets/highlight/styles/hopscotch.css">
  

  <script src="/assets/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
